name: NEORV32 RISCOF Verification

on:
  push:
  workflow_dispatch:

jobs:

  neorv32-verification:
    runs-on: ubuntu-latest

    steps:

    - name: 'üìÇ Repository checkout'
      uses: actions/checkout@v5
      with:
        fetch-depth: 0
        submodules: recursive

    - name: 'üì¶ Install Python'
      uses: actions/setup-python@v6
      with:
        python-version: '3.11'

    - name: 'üì¶ Install xPack RISC-V GCC'
      run: |
        wget -q https://github.com/xpack-dev-tools/riscv-none-elf-gcc-xpack/releases/download/v15.2.0-1/xpack-riscv-none-elf-gcc-15.2.0-1-linux-x64.tar.gz
        mkdir $GITHUB_WORKSPACE/riscv-gcc
        tar -xzf xpack-riscv-none-elf-gcc-15.2.0-1-linux-x64.tar.gz -C $GITHUB_WORKSPACE/riscv-gcc
        echo $GITHUB_WORKSPACE/riscv-gcc/xpack-riscv-none-elf-gcc-15.2.0-1/bin >> $GITHUB_PATH

    - name: 'üì¶ Install Sail RISC-V reference model'
      run: |
        mkdir $GITHUB_WORKSPACE/sail-riscv
        wget -q https://github.com/riscv/sail-riscv/releases/download/0.7/sail_riscv-Linux-x86_64.tar.gz
        tar -xzf $GITHUB_WORKSPACE/sail_riscv-Linux-x86_64.tar.gz -C $GITHUB_WORKSPACE/sail-riscv
        ls -al $GITHUB_WORKSPACE/sail-riscv/sail_riscv-Linux-x86_64/bin
        echo $GITHUB_WORKSPACE/sail-riscv/sail_riscv-Linux-x86_64/bin >> $GITHUB_PATH

    - name: 'üì¶ Install RISCOF'
      run: |
        echo "upstream RISCOF is broken! https://github.com/riscv-software-src/riscof/issues/122"
        pip3 install git+https://github.com/riscv/riscof.git@d38859f85fe407bcacddd2efcd355ada4683aee4

    - name: 'üì¶ Install GHDL'
      uses: ghdl/setup-ghdl@v1
      with:
        version: nightly
        backend: mcode

    - name: 'üîç Check tools'
      run: |
        python -V
        riscv-none-elf-gcc -v
        riscv_sim_rv32d -h
        riscof --version
        ghdl -v

    - name: '‚öôÔ∏è Run verification framework'
      run: /bin/bash -c "chmod u+x $GITHUB_WORKSPACE/run.sh && $GITHUB_WORKSPACE/run.sh"

    - name: 'üì§ Archive test report'
      uses: actions/upload-artifact@v5
      with:
        name: test_report
        path: |
          riscof_work/report.html
          riscof_work/style.css
